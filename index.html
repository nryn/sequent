<?xml version="1.0" encoding="UTF-8"?>
<html>
  <head>
    <script src="note.js"></script>
    <script src="bar.js"></script>
    <script src="phrase.js"></script>
    <script src="song.js"></script>
    <script src="playbackVisualiser.js"></script>
    <script src="sequencer.js"></script>
    <script src="instrument.js"></script>
    <script src="sound.js"></script>
    <script src="player.js"></script>
    <script src="demoSong.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Comfortaa&amp;subset=latin-ext" rel="stylesheet">
    <link rel="stylesheet" href="./styles.css">
    <script>
      const sequentPlayer = new Player();
    </script>
  </head>
  <body>
    <div id="container">
      <h1>sequent</h1>
      <div id ="workspace-controls">
        <button id="left-workspace-button" onClick="sequentPlayer.playToggle();">▶</button>
        <button id="left-workspace-button-loop" class="toggledOff" onClick="sequentPlayer.loopToggle();">↻</button>
        <div id="workspace-toggle">
          <label class="switch">
            <input type="checkbox" id="workspace-toggle-switch">
            <span class="slider round" text-after="playback" text-before="sequencer"></span>
          </label>
        </div>
        <button id="right-workspace-button" onClick="sequentPlayer.toggleSongDialogue('load');">▼</button>
      </div>
      <div id="create-song-dialogue-box" class="collapsed">
        <div id="overwrite-dialogue-box" class="collpased">
          <div class ="dialogue-text">
            <p id="new-song-warning">creating a new song. any unsaved changes to your current song will be lost.</p>
            <hr>
          </div>
        </div>
        <div class ="dialogue-text">
          <form id="create-song-form">
            <label for="song-name">song name : </label>
            <input type="text" id="song-name" placeholder="My Cool Tune">
            <label for="tempo-input">tempo : <span id="tempo-value"></span></label>
            <input type="range" id="tempo-input" min="60" max="150" value="120" step="5">
            <button type="button" id="create-sqnt-button" onClick="sequentPlayer.sequencer.createSongFromForm()">create song</button>
          </form>
          <hr>
        </div>
      </div>
      <div id="load-song-dialogue-box" class="collapsed">
        <div class ="dialogue-text">
          <textarea id="load-sqnt-textarea" placeholder="If you have a previously-saved .sqnt.txt file, please paste its contents in this text box."></textarea>
          <button id="load-sqnt-button" onClick="sequentPlayer.unpackEncodedSong()">load</button>
          <button id="demo-sqnt-button" onClick="sequentPlayer.unpackEncodedSong(demoSong)">demo</button>
          <hr>
        </div>
      </div>
      <div id="workspaces">
        <div id="playback-workspace" class="playback workspace">
          <table id="playback-grid" class="collapsed"></table>
        </div>
        <div id="sequencer-workspace" class="sequencer workspace" style="opacity:0;">
          <div id="sequencer-song-controls" class="sequencer song-controls">
            <div id="sequencer-title" class="sequencer title"></div>
            <div id="sequencer-transport-bar" class="sequencer transport-bar">
              <div id="sequencer-transport-bar-section-controls">
                <p class="transport-label">Section</p>
                <select id="sequencer-transport-bar-section-selector"></select>
                <div class="add-remove-controls">
                  <button onClick="sequentPlayer.sequencer.addPhrase();">✚</button>
                  <button onClick="sequentPlayer.sequencer.removePhrase();">✖</button>
                </div>
              </div>
              <div id="sequencer-transport-bar-instrument-controls">
                <p class="transport-label">Instrument</p>
                <div id="instrument-select-controls">
                  <select id="sequencer-transport-bar-instrument-selector"></select>
                  <div class="add-remove-controls">
                    <button onClick="sequentPlayer.sequencer.expandAddInstrumentDialogue();">✚</button>
                    <button onClick="sequentPlayer.sequencer.removeInstrument();">✖</button>
                  </div>
                </div>
                <form id="instrument-add-controls" style="display:none;">
                  <input id="add-instrument-name" type="text" placeholder="e.g. Sawtooth">
                  <div class="add-remove-controls">
                    <button id="add-instrument-button" type="button" onClick="sequentPlayer.sequencer.addInstrument();">✚</button>
                    <button type="button" onClick="sequentPlayer.sequencer.collapseAddInstrumentDialogue();">✖</button>
                  </div>
                </form>
              </div>
              <div id="instrument-add-params-annotations">
                  <svg id ="add-instrument-waveform-value" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 893 295" width="100" height="40">
                    <style>
                      tspan { white-space:pre }
                      .shp0 { display:none; fill: none;stroke: #1bbbbb;stroke-linecap:square;stroke-width: 30 } 
                    </style>
                    <path id="sine" class="shp0" d="M41.13 154.99C110.6 261.78 161.88 274.45 239.61 154.99C313.3 41.66 381.82 46.76 452.24 154.99C524.54 266.14 581.26 270.5 656.37 154.99C730.11 41.66 778.31 41.66 852 154.99"/>
                    <path id="square" class="shp0" d="M70 251L259 251L260 61L260 61L450 61L450 251L450 251L640 251L640 61L640 61L830 61"/>
                    <path id="triangle" class="shp0" d="M70 244L260 54L260 54L260 54L450 244L450 244L450 244L640 54L640 54L640 54L830 247" style="display:block;"/>
                    <path id="sawtooth" class="shp0" d="M834 244L454 54L454 54L454 54L454 244L454 244L454 244L74 54L74 54L74 54L74 247"/>
                    <path id="noise" class="shp0" d="M32.13 156.99C45.91 178.17 59.3 124.52 72 138C91.3 158.49 109.41 241.77 128.26 241.83C144.47 241.89 159.42 143.45 177.06 132.4C195.21 121.02 211.94 185.68 230.61 156.99C245.81 133.61 260.79 85.28 275.61 71.84C289.86 58.92 303.97 80.54 317.99 76.57C337.77 70.98 357.37 119.17 376.94 130.83C388.84 137.91 401.08 221.73 413 235C423.17 246.32 432.77 109.28 443 125C458.95 149.53 474.2 78.01 489 92C510.19 112.03 530.78 243.93 551.43 241.65C581.71 238.29 612.19 176.52 647 123C669.11 89.01 689.1 179.6 708 166C728.24 151.43 747.18 52.18 767 61C777.49 65.67 788.9 224.78 800 236C813.63 249.78 827.61 133.31 843 156.99"/>
                  </svg>
                <span id ="add-instrument-octave-value">3</span>
                <span id ="add-instrument-duration-value">3</span>
              </div>
              <div id="instrument-add-params-controls">
                <input type="range" min="1" max="5" value="1" class="add-instrument-slider" id="add-instrument-waveform">
                <input type="range" min="1" max="7" value="3" class="add-instrument-slider" id="add-instrument-octave">
                <input type="range" min="1" max="5" value="3" class="add-instrument-slider" id="add-instrument-duration">
              </div>
            </div>
            <div id="transport-buttons">
              <button onClick="sequentPlayer.sequencer.playPhrase();">▶</button>
              <button onClick="sequentPlayer.sequencer.addBarToSong();">add bar</button>
              <button onClick="sequentPlayer.sequencer.saveSong();">save</button>
            </div>
          </div>
          <table id="sequencer-grid" class="collapsed"></table>
        </div>
      </div>
    </div>
    <script async="true">
      // set up sliders
      const waveformSlider = document.getElementById("add-instrument-waveform");
      waveformSlider.oninput = function() {
        const allWaveformSvgs = document.getElementsByClassName('shp0');
        for (let el of allWaveformSvgs) el.setAttribute('style','display:none;');
        const svgToEnable = document.getElementById(["triangle","sine","square","sawtooth","noise"][this.value - 1]);
        svgToEnable.setAttribute('style','display:block;')
      }

      const setUpSlider = (sliderId, outputId, labelList) => {
        const slider = document.getElementById(sliderId);
        const output = document.getElementById(outputId);
        output.innerHTML = labelList ? labelList[slider.value - 1] : slider.value;
        
        slider.oninput = function() {
          output.innerHTML = labelList ? labelList[this.value - 1] : this.value;
        }
      }

      const setUpSliderHover = (slider) => {
        document.getElementById(slider).onmouseover = function(){
            document.getElementById(slider + "-value").style.opacity = 1;
        }
        document.getElementById(slider).onmouseout = function(){
            document.getElementById(slider + "-value").style.opacity = 0;
        }
      }

      setUpSlider("tempo-input", "tempo-value")
      setUpSlider("add-instrument-octave", "add-instrument-octave-value", ["real low pitch", "pretty low pitch", "low pitch", "medium pitch","high pitch","pretty high pitch","real high pitch"])
      setUpSlider("add-instrument-duration", "add-instrument-duration-value", ["real long notes","long notes","medium length notes","quick notes","real quick notes"])

      setUpSliderHover("add-instrument-waveform")
      setUpSliderHover("add-instrument-octave")
      setUpSliderHover("add-instrument-duration")


      let workspaceToggle = document.getElementById("workspace-toggle-switch");
      let workspaceContainer = document.getElementById("workspaces");
      let playbackWorkspace = document.getElementById("playback-workspace");
      let sequencerWorkspace = document.getElementById("sequencer-workspace");
      let leftWorkspaceButton = document.getElementById("left-workspace-button");
      let loopButton = document.getElementById("left-workspace-button-loop");
      workspaceToggle.addEventListener("change", swipeToWorkspace, false);
      function swipeToWorkspace() {
        if (workspaceToggle.checked) {
          // go right
          leftWorkspaceButton.innerHTML = "✚";
          leftWorkspaceButton.removeAttribute("onclick")
          leftWorkspaceButton.setAttribute("onclick", "sequentPlayer.toggleSongDialogue('create');")
          workspaceContainer.style.marginLeft = "-50%";
          workspaceContainer.style.marginRight = "0%";
          playbackWorkspace.style.opacity = "0";
          sequencerWorkspace.style.opacity = "1";
          loopButton.setAttribute("class", "disabled")
        } else {
          leftWorkspaceButton.innerHTML = sequentPlayer.isPlaying ? "◼︎" : "▶";
          leftWorkspaceButton.removeAttribute("onclick")
          leftWorkspaceButton.setAttribute("onclick", "sequentPlayer.playToggle();")
          workspaceContainer.style.marginLeft = "0%";
          workspaceContainer.style.marginRight = "-50%";
          playbackWorkspace.style.opacity = "1";
          sequencerWorkspace.style.opacity = "0";
          loopButton.setAttribute("class", sequentPlayer.loop ? "toggledOn" : "toggledOff")
        };
      };
      let loadDialogue = document.getElementById('load-song-dialogue-box');
      let createDialogue = document.getElementById('create-song-dialogue-box');
      collapseSongDialogueArea(loadDialogue);
      collapseSongDialogueArea(createDialogue);

      //making sure we capture enters in text fields
      var addInstrumentText = document.getElementById("add-instrument-name");
      addInstrumentText.addEventListener("keydown", function(event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          document.getElementById("add-instrument-button").focus();
        }
      });

      var addSongNameText = document.getElementById("song-name");
      addSongNameText.addEventListener("keydown", function(event) {
        if (event.keyCode === 13) {
          event.preventDefault();
          document.getElementById("create-sqnt-button").focus();
        }
      });

      // Instruments can be passed to Sounds to configure them.
      // const testInstrument = new Instrument("TriangleWave")
      // let foo = new Sound(sequentPlayer.context, testInstrument)
      // foo.play(440, sequentPlayer.context.currentTime, 4)

      const testInstrument = new Instrument("TriangleWave")

    </script>
  </body>
</html>
